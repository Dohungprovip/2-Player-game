<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple MOBA</title>
  <style>
    /* (C√°c style c≈© kh√¥ng thay ƒë·ªïi) */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1e1e1e, #444);
      color: #fff;
    }
    /* ... c√°c style kh√°c ... */
    /* Giao di·ªán ch·ªù tr·∫≠n v·ªõi panel s·∫µn s√†ng */
    #waitingScreen {
      display: none;
      flex-direction: column;
    }
    #readyPanel {
      display: none;
      text-align: center;
      margin-top: 20px;
    }
    #readyTimer {
      font-size: 24px;
      margin-bottom: 20px;
    }
    .ready-box {
      width: 150px;
      padding: 10px;
      margin: 10px auto;
      background-color: gray;
      color: #fff;
      border-radius: 5px;
    }
    .ready-box.ready {
      background-color: limegreen;
    }
    .spinner {
      margin-top: 20px;
    }
    /* Giao di·ªán load tr·∫≠n */
    #matchLoadingScreen {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
    }
    #topPlayerPanel {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 20px;
    }
    #bottomPlayerPanel {
      position: absolute;
      bottom: 20px;
      right: 20px;
      font-size: 20px;
    }
    #matchCountdown {
      font-size: 36px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Scoreboard, menuButton, Start Screen, Character Selection Screen, Name Screen ... (gi·ªØ nguy√™n) -->
  <!-- Start Screen -->
  <div id="startScreen" class="overlay-screen">
    <h1>Simple MOBA</h1>
    <div class="menu">
      <button id="startMenuButton">B·∫Øt ƒë·∫ßu</button>
      <button id="instructionButton">H∆∞·ªõng d·∫´n</button>
      <button id="infoButton">Th√¥ng tin nh√¢n v·∫≠t</button>
    </div>
  </div>
  
  <!-- Character Selection Screen -->
  <div id="characterSelectScreen" class="overlay-screen">
    <h1>Ch·ªçn Class</h1>
    <div id="characterOptions">
      <div class="class-btn active" data-class="knight">Knight</div>
      <div class="class-btn" data-class="archer">Archer</div>
      <div class="class-btn" data-class="mage">Mage</div>
    </div>
    <button id="nextButton">Ti·∫øp theo</button>
  </div>
  
  <!-- Name Screen -->
  <div id="nameScreen" class="overlay-screen">
    <h1>Nh·∫≠p t√™n c·ªßa b·∫°n</h1>
    <div id="nameInputs">
      <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" />
    </div>
    <button id="findMatchButton">T√¨m tr·∫≠n</button>
  </div>
  
  <!-- Waiting Screen: Panel s·∫µn s√†ng -->
  <div id="waitingScreen" class="overlay-screen">
    <h1>Ch·ªù tr·∫≠n ƒë·∫•u</h1>
    <div id="readyPanel">
      <div id="readyTimer">5</div>
      <div id="readyContainer">
        <div id="localReady" class="ready-box">B·∫°n: Ch∆∞a s·∫µn s√†ng</div>
        <div id="opponentReady" class="ready-box">ƒê·ªëi th·ªß: Ch∆∞a s·∫µn s√†ng</div>
      </div>
      <button id="readyButton">S·∫µn s√†ng</button>
    </div>
    <div class="spinner" id="waitingSpinner"></div>
  </div>
  
  <!-- Match Loading Screen -->
  <div id="matchLoadingScreen" class="overlay-screen">
    <div id="topPlayerPanel"></div>
    <div id="bottomPlayerPanel"></div>
    <div id="matchCountdown">10</div>
  </div>
  
  <!-- Canvas Game -->
  <canvas id="gameCanvas" width="800" height="600"></canvas>
  
  <!-- Skill Slots cho Local Player -->
  <div id="skillContainer">
    <!-- (Gi·ªØ nguy√™n ph·∫ßn skill) -->
    <div class="skill-slot" id="skill-attack">
      <div class="skill-icon">‚öîÔ∏è</div>
      <div class="cooldown-overlay" id="skill-attack-overlay">
        <div class="cooldown-timer" id="skill-attack-timer"></div>
      </div>
    </div>
    <div class="skill-slot" id="skill-counter">
      <div class="skill-icon">üõ°Ô∏è</div>
      <div class="cooldown-overlay" id="skill-counter-overlay">
        <div class="cooldown-timer" id="skill-counter-timer"></div>
      </div>
    </div>
    <div class="skill-slot" id="skill-special">
      <div class="skill-icon">‚≠ê</div>
      <div class="cooldown-overlay" id="skill-special-overlay">
        <div class="cooldown-timer" id="skill-special-timer"></div>
      </div>
    </div>
    <div class="skill-slot" id="skill-ultimate">
      <div class="skill-icon">‚ú¥</div>
      <div class="cooldown-overlay" id="skill-ultimate-overlay">
        <div class="cooldown-timer" id="skill-ultimate-timer"></div>
      </div>
    </div>
  </div>
  
  <script>
    // --- Global Variables & Key State ---
    let player, opponent;
    let localName = "";
    let selectedCharacterLeft = "knight";
    let roomId;
    let keys = {};
    let localReady = false;
    let remoteReady = false;
    
    document.addEventListener("keydown", (e) => { 
      keys[e.key] = true;
      if(socket.connected) socket.emit("player_move", { roomId, playerId: socket.id, key: e.key });
    });
    document.addEventListener("keyup", (e) => { keys[e.key] = false; });
    
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    let score = 0;
    function updateScoreboard() {
      document.getElementById("scoreboard").textContent = `Score: ${score}`;
    }
    function clamp(val, min, max) {
      return Math.min(Math.max(val, min), max);
    }
    
    // --- Skill Cooldown & c√°c h√†m game kh√°c (gi·ªØ nguy√™n) ---
    function startSkillCooldown(overlayId, timerId, duration) {
      const overlay = document.getElementById(overlayId);
      const timerElem = document.getElementById(timerId);
      overlay.style.opacity = "1";
      timerElem.style.opacity = "1";
      let startTime = Date.now();
      function update() {
        let elapsed = Date.now() - startTime;
        let remaining = Math.ceil((duration - elapsed) / 1000);
        timerElem.textContent = remaining > 0 ? remaining : "";
        if (elapsed < duration) {
          requestAnimationFrame(update);
        } else {
          overlay.style.opacity = "0";
          timerElem.textContent = "";
        }
      }
      update();
    }
    
    // ... (C√°c h√†m x·ª≠ l√Ω hi·ªáu ·ª©ng, v·∫Ω ƒë·ªëi t∆∞·ª£ng, gameLoop, v.v. gi·ªØ nguy√™n) ...
    
    // --- Flow: Start -> Class Selection -> Name Input -> T√¨m tr·∫≠n -> Ready Panel ---
    const socket = io("https://two-player-game.onrender.com");
    
    // Khi nh·∫•n "B·∫Øt ƒë·∫ßu" t·ª´ Start Screen
    document.getElementById("startMenuButton").addEventListener("click", () => {
      document.getElementById("startScreen").style.display = "none";
      document.getElementById("characterSelectScreen").style.display = "flex";
    });
    
    // L·∫Øng nghe ch·ªçn class
    const classButtons = document.querySelectorAll(".class-btn");
    classButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        selectedCharacterLeft = btn.getAttribute("data-class");
        classButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });
    
    // Khi nh·∫•n "Ti·∫øp theo" ·ªü m√†n h√¨nh ch·ªçn class
    document.getElementById("nextButton").addEventListener("click", () => {
      document.getElementById("characterSelectScreen").style.display = "none";
      document.getElementById("nameScreen").style.display = "flex";
    });
    
    // Khi nh·∫•n "T√¨m tr·∫≠n" ·ªü m√†n h√¨nh nh·∫≠p t√™n
    document.getElementById("findMatchButton").addEventListener("click", () => {
      localName = document.getElementById("playerName").value.trim() || "Player";
      socket.emit("find_match", { name: localName, character: selectedCharacterLeft });
      document.getElementById("nameScreen").style.display = "none";
      document.getElementById("waitingScreen").style.display = "flex";
      // Hi·ªÉn th·ªã panel s·∫µn s√†ng
      document.getElementById("readyPanel").style.display = "block";
    });
    
    // Khi nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o t√¨m ƒë∆∞·ª£c ƒë·ªëi th·ªß
    socket.on("match_found", (data) => {
      roomId = data.roomId;
      console.log("ƒê√£ t√¨m ƒë∆∞·ª£c ƒë·ªëi th·ªß!");
      // B·∫°n c√≥ th·ªÉ c·∫≠p nh·∫≠t UI th√¥ng b√°o "ƒê√£ t√¨m ƒë∆∞·ª£c ƒë·ªëi th·ªß" n·∫øu mu·ªën.
    });
    
    // Khi nh·∫•n "S·∫µn s√†ng" trong panel ready
    document.getElementById("readyButton").addEventListener("click", () => {
      if (!localReady) {
        localReady = true;
        document.getElementById("localReady").classList.add("ready");
        document.getElementById("localReady").textContent = "B·∫°n: S·∫µn s√†ng";
        socket.emit("player_ready", { roomId, playerId: socket.id });
      }
    });
    
    socket.on("opponent_ready", () => {
      remoteReady = true;
      document.getElementById("opponentReady").classList.add("ready");
      document.getElementById("opponentReady").textContent = "ƒê·ªëi th·ªß: S·∫µn s√†ng";
    });
    
    // Khi c·∫£ 2 ng∆∞·ªùi ch∆°i s·∫µn s√†ng, server g·ª≠i th√¥ng tin spawn, m√†u v√† ƒë·ªëi th·ªß
    socket.on("both_players_ready", (data) => {
      roomId = data.roomId;
      // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c 5 gi√¢y (tr∆∞·ªõc khi chuy·ªÉn sang giao di·ªán load tr·∫≠n)
      let countdown = 5;
      document.getElementById("readyTimer").textContent = countdown;
      let countdownInterval = setInterval(() => {
         countdown--;
         document.getElementById("readyTimer").textContent = countdown;
         if (countdown <= 0) {
             clearInterval(countdownInterval);
             showMatchLoadingScreen(data);
         }
      }, 1000);
    });
    
    // H√†m hi·ªÉn th·ªã giao di·ªán load tr·∫≠n v·ªõi ƒë·∫øm ng∆∞·ª£c 10 gi√¢y
    function showMatchLoadingScreen(data) {
      // ·∫®n giao di·ªán ch·ªù tr·∫≠n
      document.getElementById("waitingScreen").style.display = "none";
      // Hi·ªÉn th·ªã giao di·ªán load tr·∫≠n
      document.getElementById("matchLoadingScreen").style.display = "flex";
      
      let localSpawn = data.spawn;
      let localColor = data.color;
      let opponentData = data.opponent;
      let localClass = selectedCharacterLeft;
      
      let topPlayerInfo = "";
      let bottomPlayerInfo = "";
      
      // N·∫øu localSpawn.x == 50 th√¨ ng∆∞·ªùi ch∆°i c·ªßa b·∫°n s·∫Ω xu·∫•t hi·ªán ·ªü g√≥c tr√™n b√™n tr√°i
      if(localSpawn.x === 50) {
          topPlayerInfo = `B·∫°n: ${localName} (${localClass})`;
          bottomPlayerInfo = `ƒê·ªëi th·ªß: ${opponentData.name} (${opponentData.character})`;
      } else {
          topPlayerInfo = `ƒê·ªëi th·ªß: ${opponentData.name} (${opponentData.character})`;
          bottomPlayerInfo = `B·∫°n: ${localName} (${localClass})`;
      }
      document.getElementById("topPlayerPanel").textContent = topPlayerInfo;
      document.getElementById("bottomPlayerPanel").textContent = bottomPlayerInfo;
      
      // ƒê·∫øm ng∆∞·ª£c 10 gi√¢y trong giao di·ªán load tr·∫≠n
      let matchCountdown = 10;
      document.getElementById("matchCountdown").textContent = matchCountdown;
      let matchCountdownInterval = setInterval(() => {
         matchCountdown--;
         document.getElementById("matchCountdown").textContent = matchCountdown;
         if (matchCountdown <= 0) {
             clearInterval(matchCountdownInterval);
             document.getElementById("matchLoadingScreen").style.display = "none";
             // X√°c ƒë·ªãnh v·ªã tr√≠ spawn cho ƒë·ªëi th·ªß (ng∆∞·ª£c v·ªõi v·ªã tr√≠ c·ªßa b·∫°n)
             let opponentSpawn = (localSpawn.x === 50) ? {x:750, y:550} : {x:50, y:50};
             createLocalPlayerWithSpawn(localSpawn, localColor);
             createOpponentPlayerWithSpawn(opponentData, opponentSpawn, (localColor === "blue") ? "red" : "blue");
             gameLoop();
         }
      }, 1000);
    }
    
    socket.on("opponent_left", () => {
      alert("‚ùå ƒê·ªëi th·ªß ƒë√£ r·ªùi kh·ªèi tr·∫≠n ƒë·∫•u!");
      location.reload();
    });
    
    socket.on("update_game", ({ playerId, key }) => {
      let target = (playerId === socket.id) ? player : opponent;
      if (key === "ArrowLeft" || key === "a") target.x -= 5;
      if (key === "ArrowRight" || key === "d") target.x += 5;
      if (key === "ArrowUp" || key === "w") target.y -= 5;
      if (key === "ArrowDown" || key === "s") target.y += 5;
    });
    
    document.getElementById("menuButton").addEventListener("click", () => {
      location.reload();
    });
    
    // --- H√†m t·∫°o ƒë·ªëi t∆∞·ª£ng v·ªõi spawn ---
    function createLocalPlayerWithSpawn(spawn, assignedColor) {
      if(selectedCharacterLeft === "archer") {
        player = new Player(spawn.x, spawn.y, assignedColor, { left:"a", right:"d", up:"w", down:"s", attack:" ", counter:"c", ultimate:"v" }, "left", "archer");
      } else if(selectedCharacterLeft === "mage") {
        player = new Player(spawn.x, spawn.y, assignedColor, { left:"a", right:"d", up:"w", down:"s", attack:" ", counter:"c", ultimate:"v" }, "left", "mage");
      } else {
        player = new Player(spawn.x, spawn.y, assignedColor, { left:"a", right:"d", up:"w", down:"s", attack:" ", counter:"c", ultimate:"v" }, "left", "knight");
      }
      player.name = localName;
    }
    function createOpponentPlayerWithSpawn(oppData, spawn, oppColor) {
      let oppChar = oppData.character || "knight";
      opponent = new Player(spawn.x, spawn.y, oppColor, { left:"ArrowLeft", right:"ArrowRight", up:"ArrowUp", down:"ArrowDown", attack:"Enter", counter:"/", ultimate:"ShiftRight" }, "right", oppChar);
      opponent.name = oppData.name;
    }
    
    function resetRound() {
      if(player) {
        player.health = (player.characterType === "archer" || player.characterType === "mage") ? 280 : 300;
        player.x = 50; player.y = 50;
        player.lastUltimateTime = 0;
      }
      if(opponent) {
        opponent.health = (opponent.characterType === "archer" || opponent.characterType === "mage") ? 280 : 300;
        opponent.x = 750; opponent.y = 550;
        opponent.lastUltimateTime = 0;
      }
      clearAllEffects();
    }
    
    function gameLoop() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      if(player) {
        player.move(keys);
        player.draw();
      }
      if(opponent) opponent.draw();
      updateEffects();
      updateTrails();
      updateProjectiles();
      updateIceZones();
      updateThunderZones();
      drawProjectiles();
      drawIceZones();
      drawThunderZones();
      if(player && opponent && (player.health <= 0 || opponent.health <= 0)) {
        score++;
        updateScoreboard();
        clearAllEffects();
        resetRound();
      }
      requestAnimationFrame(gameLoop);
    }
    
    // C√°c h√†m v√† logic kh√°c (attack, special, v.v.) gi·ªØ nguy√™n...
    
  </script>
</body>
</html>
